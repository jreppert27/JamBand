{% extends "base.html" %}

{% block content %}
  <!-- Colored Header -->
  <div class="profile-header" style="background-color: #3378d4; height: 300px;"></div>

  <!-- Avatar, Name & Follow Button -->
  <div class="d-flex justify-content-center" style="margin-top: -75px;">
    <div class="text-center">
      <img
        src="{{ user.avatar(150) }}"
        alt="{{ user.username }}'s avatar"
        class="rounded-circle border border-white"
        style="width: 150px; height: 150px;"
      >
      <h1 class="mt-3">{{ user.username }}</h1>
      {% if current_user.id != user.id %}
        <form method="post" class="mt-2">
          {{ form.hidden_tag() }}
          {% if is_following %}
            {{ form.submit(class="btn btn-outline-secondary", value="Unfollow") }}
          {% else %}
            {{ form.submit(class="btn btn-primary", value="Follow") }}
          {% endif %}
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Profile Edit Form (only for owner) -->
  {% if current_user.id == user.id %}
    <form method="POST" enctype="multipart/form-data">
  {% endif %}

  <!-- About Me -->
  <div class="profile-bio mt-5">
    <h2>About Me</h2>
    {% if current_user.id == user.id %}
      <textarea name="about_me" class="form-control" rows="5">{{ user.about_me }}</textarea>
    {% else %}
      <p>{{ user.about_me or "No bio available." }}</p>
    {% endif %}
  </div>

  <!-- Posts in a Pinterest-style masonry grid -->
  <style>
    .pinterest-container {
      column-count: 4;
      column-gap: 1rem;
    }
    .pin-card {
      display: inline-block;
      width: 100%;
      margin-bottom: 1rem;
      break-inside: avoid;
    }
  </style>

  <h2 class="mt-5 mb-4">Posts</h2>
  <div class="pinterest-container">
    {% if user.posts %}
      {% for post in user.posts %}
        <div class="pin-card">
          <div class="card shadow-sm h-100">
            {% if post.media_path %}
              <img
                src="{{ url_for('static', filename='uploads/' ~ post.media_path) }}"
                class="card-img-top"
                style="object-fit: cover; max-height: 200px;"
                alt="Post media"
              >
            {% endif %}
            <div class="card-body">
              <h5 class="card-title">{{ post.header }}</h5>
              <p class="card-text">{{ post.body }}</p>
              <small class="text-muted">{{ post.timestamp.strftime('%b %d, %Y') }}</small>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No posts to display.</p>
    {% endif %}
  </div>

  <!-- Groups -->
  <div class="profile-groups mt-4">
    <h2>Groups</h2>
    <div class="list-group">
      {% for group in groups %}
        <a href="{{ url_for('group', group_id=group.id) }}" class="list-group-item list-group-item-action">
          <h5 class="mb-1">{{ group.name }}</h5>
          <p class="mb-1">{{ group.bio or "No description provided." }}</p>
        </a>
      {% else %}
        <p>No groups to display.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Save Button & Close Form -->
  {% if current_user.id == user.id %}
      <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
    </form>
  {% endif %}

  <!-- Bottom spacer -->
  <div class="mb-5"></div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Profile page loaded for user:", "{{ user.username }}");
  });
</script>
{% endblock %}
