{% extends "base.html" %}

{% block content %}
  <!-- Colored Header with Banner Image -->
  {% if user.banner_path %}
    <div class="profile-header"
         style="height: 300px;
                background-image: url('{{ url_for('static', filename='uploads/' + user.banner_path) }}');
                background-size: cover; background-position: center;">
    </div>
  {% else %}
    <div class="profile-header"
         style="height: 300px; background-color: #3378d4;"></div>
  {% endif %}
{% if user.banner_path %}
<div class="profile-header"
     style="height: 300px; background-image: url('{{ url_for('static', filename='uploads/' + user.banner_path) }}');
           background-size: cover; background-position: center;"></div>
{% else %}
<div class="profile-header"
     style="height: 300px; background-color: #3378d4;"></div>
{% endif %}

  <!-- Avatar, Name & Action Button -->
  <div class="d-flex justify-content-center" style="margin-top: -75px;">
    <div class="text-center">
      <img
        src="{{ user.avatar(150) }}"
        alt="{{ user.username }}'s avatar"
        class="rounded-circle border border-white"
        style="width: 150px; height: 150px; object-fit: cover;"
      >
      <h1 class="mt-3">{{ user.username }}</h1>
<!-- Avatar, Name & Edit Profile Button -->
<div class="d-flex justify-content-center" style="margin-top: -75px;">
  <div class="text-center">
    <img
      src="{{ user.avatar(150) }}"
      alt="{{ user.username }}'s avatar"
      class="rounded-circle border border-white"
      style="width: 150px; height: 150px; object-fit: cover;"
    >
    <h1 class="mt-3">{{ user.username }}</h1>

      {% if current_user.id == user.id %}
        <!-- Edit Profile Button for owner -->
        <button type="button" class="btn btn-primary mt-2"
                data-bs-toggle="modal" data-bs-target="#editProfileModal">
          Edit Profile
        </button>
      {% else %}
        <!-- Follow/Unfollow form for others -->
        <form method="POST" class="mt-2">
          {{ follow_form.hidden_tag() }}
          {% if is_following %}
            {{ follow_form.submit(class="btn btn-outline-secondary", value="Unfollow") }}
          {% else %}
            {{ follow_form.submit(class="btn btn-primary", value="Follow") }}
          {% endif %}
        </form>
      {% endif %}
    </div>
  </div>
    {% if current_user.id == user.id %}
      <!-- Edit Profile Button -->
      <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
        Edit Profile
      </button>
    {% else %}
      <!-- Follow/Unfollow Button -->
      <form method="post" class="mt-2">
        {{ form.hidden_tag() }}
        {% if is_following %}
          {{ form.submit(class="btn btn-outline-secondary", value="Unfollow") }}
        {% else %}
          {{ form.submit(class="btn btn-primary", value="Follow") }}
        {% endif %}
      </form>
    {% endif %}
  </div>
</div>

  <!-- About Me -->
  <div class="profile-bio mt-5">
    <h2>About Me</h2>
    <p>{{ user.about_me or "No bio available." }}</p>
  </div>

  <!-- Posts in a Pinterest-style masonry grid -->
  <style>
    .pinterest-container { column-count: 4; column-gap: 1rem; }
    .pin-card { display: inline-block; width: 100%; margin-bottom: 1rem; break-inside: avoid; }
    .pinned-post { border-left: 4px solid #0d6efd; }
  </style>

  <h2 class="mt-5 mb-4">Posts</h2>
  <div class="pinterest-container">
    {% if user.posts %}
      {% for post in user.posts %}
        <div class="pin-card">
          <div class="card shadow-sm h-100 {% if post.is_pinned %}pinned-post{% endif %}">
            {% if post.media_path %}
              <img
                src="{{ url_for('static', filename='uploads/' + post.media_path) }}"
                class="card-img-top"
                style="object-fit: cover; max-height: 200px;"
                alt="Post media"
              >
            {% endif %}
            <div class="card-body">
              <h5 class="card-title">{{ post.header }}</h5>
              <p class="card-text">{{ post.body }}</p>
              <small class="text-muted">{{ post.timestamp.strftime('%b %d, %Y') }}</small>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No posts to display.</p>
    {% endif %}
  </div>

  <!-- Groups -->
  <div class="profile-groups mt-4">
    <h2>Groups</h2>
    <div class="list-group">
      {% for group in groups %}
        <a href="{{ url_for('main.group', group_id=group.id) }}"
           class="list-group-item list-group-item-action">
          <h5 class="mb-1">{{ group.name }}</h5>
          <p class="mb-1">{{ group.bio or "No description provided." }}</p>
        </a>
      {% else %}
        <p>No groups to display.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('main.update_profile') }}" enctype="multipart/form-data">
        <!-- Add CSRF token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="modal-body">
          <!-- Profile Picture Upload -->
          <div class="mb-4">
            <label for="profilePicture" class="form-label fw-bold">Profile Picture</label>
            <div class="d-flex align-items-center mb-2">
              <img src="{{ user.avatar(100) }}" class="rounded-circle me-3" alt="Current avatar" style="width: 100px; height: 100px; object-fit: cover;">
              <div>
                <input type="file" class="form-control" id="profilePicture" name="profile_picture" accept="image/*">
                <div class="form-text">Upload a square image for your profile avatar.</div>
              </div>

  <!-- Edit Profile Modal (owner only) -->
  {% if current_user.id == user.id %}
  <div class="modal fade" id="editProfileModal" tabindex="-1"
       aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST"
              action="{{ url_for('main.user', username=user.username) }}"
              enctype="multipart/form-data">
          {{ edit_profile_form.hidden_tag() }}

          <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close"
                    data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-4">
              {{ edit_profile_form.profile_picture.label(class="form-label") }}
              {{ edit_profile_form.profile_picture(class="form-control") }}
              <div class="form-text">Upload a square avatar (e.g. 200×200px).</div>
            </div>

            <div class="mb-4">
              {{ edit_profile_form.profile_banner.label(class="form-label") }}
              {{ edit_profile_form.profile_banner(class="form-control") }}
              <div class="form-text">Recommended banner size: 1500×500px.</div>
            </div>

            <div class="mb-3">
              {{ edit_profile_form.about_me.label(class="form-label") }}
              {{ edit_profile_form.about_me(class="form-control", rows="4") }}
              <div class="form-text">Tell others about yourself (max 140 chars).</div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancel</button>
            {{ edit_profile_form.submit(class="btn btn-primary") }}
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}


  <!-- Bottom spacer -->
  <div class="mb-5"></div>
{% endblock %}

{% block scripts %}
<script>
  console.log("Profile page loaded for:", "{{ user.username }}");
</script>
{% endblock %}
